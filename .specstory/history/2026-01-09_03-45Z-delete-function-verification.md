<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 5b2a0f07-ee3b-4a4b-93b4-7cd4cc66c7b9 (2026-01-09 03:45Z) -->

# Delete function verification (2026-01-09 03:45Z)

_**User (2026-01-25 15:50Z)**_

Check the delete function. Make sure they works.

---

_**Agent (model default, mode Plan)**_



---

Searching the codebase for delete functions and reviewing their implementations.


---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "delete function implementation API routes" • **12** results</summary>
            
| File | Lines |
|------|-------|
| `src/app/api/raw-materials/[id]/route.ts` | L59-153 |
| `src/app/api/users/[id]/route.ts` | L178-257 |
| `src/app/api/finished-goods/[id]/route.ts` | L65-106 |
| `src/app/api/batches/[id]/route.ts` | L247-320 |
| `src/app/api/stock-movements/by-date/route.ts` | L80 |
| `src/lib/api-client.ts` | L82-94 |
| `src/app/api/stock-movements/by-date/route.ts` | L19-138 |
| `src/app/api/stock-movements/by-date/route.ts` | L19-80 |
| `src/app/finished-goods/page.tsx` | L14-298 |
| `src/app/raw-materials/page.tsx` | L23-246 |
| `src/lib/queries/raw-materials.ts` | L62-89 |
| `src/app/batches/page.tsx` | L18-179 |

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "delete|DELETE" in "src/app/api" • 145 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `src/app/api/stock-movements/[id]/route.ts` | `canDeleteStockMovements,` | L6 |
| `src/app/api/stock-movements/[id]/route.ts` | `import \{ updateStockMovement, deleteStockMovement \} from '@/lib/services'` | L10 |
| `src/app/api/stock-movements/[id]/route.ts` | `* DELETE /api/stock-movements/[id]` | L102 |
| `src/app/api/stock-movements/[id]/route.ts` | `* Delete individual stock movement` | L104 |
| `src/app/api/stock-movements/[id]/route.ts` | `* - Requires ADMIN role (canDeleteStockMovements)` | L111 |
| `src/app/api/stock-movements/[id]/route.ts` | `export async function DELETE(` | L121 |
| `src/app/api/stock-movements/[id]/route.ts` | `if (!canDeleteStockMovements(session.user.role)) \{` | L132 |
| `src/app/api/stock-movements/[id]/route.ts` | `'delete stock movements',` | L136 |
| `src/app/api/stock-movements/[id]/route.ts` | `// Delete stock movement using service` | L149 |
| `src/app/api/stock-movements/[id]/route.ts` | `await deleteStockMovement(validatedId)` | L150 |
| `src/app/api/stock-movements/[id]/route.ts` | `message: 'Stock movement deleted successfully',` | L153 |
| `src/app/api/stock-movements/[id]/route.ts` | `\{ error: 'Failed to delete stock movement' \},` | L180 |
| `src/app/api/raw-materials/[id]/route.ts` | `canDeleteMaterials,` | L6 |
| `src/app/api/raw-materials/[id]/route.ts` | `deleteRawMaterial,` | L13 |
| `src/app/api/raw-materials/[id]/route.ts` | `export async function DELETE(` | L113 |
| `src/app/api/raw-materials/[id]/route.ts` | `if (!canDeleteMaterials(session.user.role)) \{` | L124 |
| `src/app/api/raw-materials/[id]/route.ts` | `'delete raw materials',` | L128 |
| `src/app/api/raw-materials/[id]/route.ts` | `// Delete raw material using service` | L138 |
| `src/app/api/raw-materials/[id]/route.ts` | `await deleteRawMaterial(id)` | L139 |
| `src/app/api/raw-materials/[id]/route.ts` | `return NextResponse.json(\{ message: 'Raw material deleted successfully' \})` | L141 |
| `src/app/api/raw-materials/[id]/route.ts` | `\{ error: 'Failed to delete raw material' \},` | L150 |
| `src/app/api/batches/[id]/route.ts` | `canDeleteBatches,` | L8 |
| `src/app/api/batches/[id]/route.ts` | `deleteBatch,` | L14 |
| `src/app/api/batches/[id]/route.ts` | `export async function DELETE(` | L106 |
| `src/app/api/batches/[id]/route.ts` | `if (!canDeleteBatches(session.user.role)) \{` | L117 |
| `src/app/api/batches/[id]/route.ts` | `error: getPermissionErrorMessage('delete batches', session.user.role),` | L120 |
| `src/app/api/batches/[id]/route.ts` | `// Delete batch using service (includes stock restoration)` | L131 |
| `src/app/api/batches/[id]/route.ts` | `await deleteBatch(id)` | L132 |
| `src/app/api/batches/[id]/route.ts` | `await AuditHelpers.batchDeleted(existingBatch.code, '', \{` | L135 |
| `src/app/api/batches/[id]/route.ts` | `message: 'Batch deleted successfully and stock restored',` | L142 |
| `src/app/api/batches/[id]/route.ts` | `\{ error: 'Failed to delete batch' \},` | L152 |
| `src/app/api/locations/[id]/route.ts` | `import \{ updateLocation, deleteLocation \} from '@/lib/services/location.service'` | L2 |
| `src/app/api/locations/[id]/route.ts` | `export async function DELETE(` | L36 |
| `src/app/api/locations/[id]/route.ts` | `await deleteLocation(id)` | L42 |
| `src/app/api/finished-goods/[id]/route.ts` | `canDeleteFinishedGoods,` | L6 |
| `src/app/api/finished-goods/[id]/route.ts` | `import \{ updateFinishedGood, deleteFinishedGood \} from '@/lib/services'` | L11 |
| `src/app/api/finished-goods/[id]/route.ts` | `export async function DELETE(` | L66 |
| `src/app/api/finished-goods/[id]/route.ts` | `if (!canDeleteFinishedGoods(session.user.role)) \{` | L77 |
| `src/app/api/finished-goods/[id]/route.ts` | `'delete finished goods',` | L81 |
| `src/app/api/finished-goods/[id]/route.ts` | `// Delete finished good using service` | L91 |
| `src/app/api/finished-goods/[id]/route.ts` | `await deleteFinishedGood(id)` | L92 |
| `src/app/api/finished-goods/[id]/route.ts` | `return NextResponse.json(\{ message: 'Finished good deleted successfully' \})` | L94 |
| `src/app/api/finished-goods/[id]/route.ts` | `\{ error: 'Failed to delete finished good' \},` | L103 |
| `src/app/api/__tests__/stock-movements-by-date.integration.test.ts` | `import \{ DELETE, PUT \} from '../stock-movements/by-date/route'` | L7 |
| `src/app/api/__tests__/stock-movements-by-date.integration.test.ts` | `deleteStockMovementsByDate,` | L9 |
| `src/app/api/__tests__/stock-movements-by-date.integration.test.ts` | `import \{ canDeleteStockMovements, canEditStockMovements \} from '@/lib/rbac'` | L13 |
| `src/app/api/__tests__/stock-movements-by-date.integration.test.ts` | `deleteStockMovementsByDate: vi.fn(),` | L17 |
| `src/app/api/__tests__/stock-movements-by-date.integration.test.ts` | `canDeleteStockMovements: vi.fn(),` | L26 |
| `src/app/api/__tests__/stock-movements-by-date.integration.test.ts` | `describe('DELETE /api/stock-movements/by-date', () => \{` | L44 |
| `src/app/api/__tests__/stock-movements-by-date.integration.test.ts` | `method: 'DELETE',` | L52 |
| `src/app/api/__tests__/stock-movements-by-date.integration.test.ts` | `const response = await DELETE(request)` | L56 |
| `src/app/api/__tests__/stock-movements-by-date.integration.test.ts` | `expect(deleteStockMovementsByDate).not.toHaveBeenCalled()` | L60 |
| `src/app/api/__tests__/stock-movements-by-date.integration.test.ts` | `vi.mocked(canDeleteStockMovements).mockReturnValue(false)` | L72 |
| `src/app/api/__tests__/stock-movements-by-date.integration.test.ts` | `method: 'DELETE',` | L77 |
| `src/app/api/__tests__/stock-movements-by-date.integration.test.ts` | `const response = await DELETE(request)` | L81 |
| `src/app/api/__tests__/stock-movements-by-date.integration.test.ts` | `expect(deleteStockMovementsByDate).not.toHaveBeenCalled()` | L85 |
| `src/app/api/__tests__/stock-movements-by-date.integration.test.ts` | `it('should delete stock movements when authorized', async () => \{` | L88 |
| `src/app/api/__tests__/stock-movements-by-date.integration.test.ts` | `vi.mocked(canDeleteStockMovements).mockReturnValue(true)` | L97 |
| `src/app/api/__tests__/stock-movements-by-date.integration.test.ts` | `vi.mocked(deleteStockMovementsByDate).mockResolvedValue(undefined)` | L98 |
| `src/app/api/__tests__/stock-movements-by-date.integration.test.ts` | `method: 'DELETE',` | L103 |
| `src/app/api/__tests__/stock-movements-by-date.integration.test.ts` | `const response = await DELETE(request)` | L107 |
| `src/app/api/__tests__/stock-movements-by-date.integration.test.ts` | `expect(deleteStockMovementsByDate).toHaveBeenCalled()` | L112 |
| `src/app/api/__tests__/batches.integration.test.ts` | `import \{ GET as GET_BY_ID, PUT, DELETE \} from '../batches/[id]/route'` | L11 |
| `src/app/api/__tests__/batches.integration.test.ts` | `deleteBatch,` | L17 |
| `src/app/api/__tests__/batches.integration.test.ts` | `import \{ canCreateBatches, canEditBatches, canDeleteBatches \} from '@/lib/rbac'` | L20 |
| `src/app/api/__tests__/batches.integration.test.ts` | `deleteBatch: vi.fn(),` | L32 |
| `src/app/api/__tests__/batches.integration.test.ts` | `canDeleteBatches: vi.fn(),` | L42 |
| `src/app/api/__tests__/batches.integration.test.ts` | `batchDeleted: vi.fn().mockResolvedValue(undefined),` | L59 |
| `src/app/api/__tests__/batches.integration.test.ts` | `describe('DELETE /api/batches/[id]', () => \{` | L384 |
| `src/app/api/__tests__/batches.integration.test.ts` | `method: 'DELETE',` | L390 |
| `src/app/api/__tests__/batches.integration.test.ts` | `const response = await DELETE(request, \{` | L393 |
| `src/app/api/__tests__/batches.integration.test.ts` | `expect(deleteBatch).not.toHaveBeenCalled()` | L399 |
| `src/app/api/__tests__/batches.integration.test.ts` | `vi.mocked(canDeleteBatches).mockReturnValue(false)` | L411 |
| `src/app/api/__tests__/batches.integration.test.ts` | `method: 'DELETE',` | L414 |
| `src/app/api/__tests__/batches.integration.test.ts` | `const response = await DELETE(request, \{` | L417 |
| `src/app/api/__tests__/batches.integration.test.ts` | `expect(deleteBatch).not.toHaveBeenCalled()` | L423 |
| `src/app/api/__tests__/batches.integration.test.ts` | `it('should delete batch when authorized', async () => \{` | L426 |
| `src/app/api/__tests__/batches.integration.test.ts` | `vi.mocked(canDeleteBatches).mockReturnValue(true)` | L435 |
| `src/app/api/__tests__/batches.integration.test.ts` | `vi.mocked(deleteBatch).mockResolvedValue(undefined)` | L436 |
| `src/app/api/__tests__/batches.integration.test.ts` | `method: 'DELETE',` | L439 |
| `src/app/api/__tests__/batches.integration.test.ts` | `const response = await DELETE(request, \{` | L448 |
| `src/app/api/__tests__/batches.integration.test.ts` | `expect(deleteBatch).toHaveBeenCalledWith('123')` | L455 |
| `src/app/api/__tests__/raw-materials-id.integration.test.ts` | `import \{ PUT, DELETE \} from '../raw-materials/[id]/route'` | L7 |
| `src/app/api/__tests__/raw-materials-id.integration.test.ts` | `import \{ updateRawMaterial, deleteRawMaterial \} from '@/lib/services'` | L8 |
| `src/app/api/__tests__/raw-materials-id.integration.test.ts` | `import \{ canManageMaterials, canDeleteMaterials \} from '@/lib/rbac'` | L10 |
| `src/app/api/__tests__/raw-materials-id.integration.test.ts` | `deleteRawMaterial: vi.fn(),` | L18 |
| `src/app/api/__tests__/raw-materials-id.integration.test.ts` | `canDeleteMaterials: vi.fn(),` | L27 |
| `src/app/api/__tests__/raw-materials-id.integration.test.ts` | `describe('DELETE /api/raw-materials/[id]', () => \{` | L140 |
| `src/app/api/__tests__/raw-materials-id.integration.test.ts` | `method: 'DELETE',` | L148 |
| `src/app/api/__tests__/raw-materials-id.integration.test.ts` | `const response = await DELETE(request, \{` | L152 |
| `src/app/api/__tests__/raw-materials-id.integration.test.ts` | `expect(deleteRawMaterial).not.toHaveBeenCalled()` | L158 |
| `src/app/api/__tests__/raw-materials-id.integration.test.ts` | `vi.mocked(canDeleteMaterials).mockReturnValue(false)` | L170 |
| `src/app/api/__tests__/raw-materials-id.integration.test.ts` | `method: 'DELETE',` | L175 |
| `src/app/api/__tests__/raw-materials-id.integration.test.ts` | `const response = await DELETE(request, \{` | L179 |
| `src/app/api/__tests__/raw-materials-id.integration.test.ts` | `expect(deleteRawMaterial).not.toHaveBeenCalled()` | L185 |
| `src/app/api/__tests__/raw-materials-id.integration.test.ts` | `it('should delete raw material when authorized', async () => \{` | L188 |
| `src/app/api/__tests__/raw-materials-id.integration.test.ts` | `vi.mocked(canDeleteMaterials).mockReturnValue(true)` | L197 |
| `src/app/api/__tests__/raw-materials-id.integration.test.ts` | `vi.mocked(deleteRawMaterial).mockResolvedValue(undefined)` | L198 |
| `src/app/api/__tests__/raw-materials-id.integration.test.ts` | `method: 'DELETE',` | L203 |
| `src/app/api/__tests__/raw-materials-id.integration.test.ts` | `const response = await DELETE(request, \{` | L207 |
| `src/app/api/__tests__/raw-materials-id.integration.test.ts` | `expect(deleteRawMaterial).toHaveBeenCalledWith('123')` | L214 |
| `src/app/api/__tests__/finished-goods.integration.test.ts` | `import \{ PUT, DELETE \} from '../finished-goods/[id]/route'` | L11 |
| `src/app/api/__tests__/finished-goods.integration.test.ts` | `deleteFinishedGood,` | L16 |
| `src/app/api/__tests__/finished-goods.integration.test.ts` | `import \{ canManageFinishedGoods, canDeleteFinishedGoods \} from '@/lib/rbac'` | L19 |
| `src/app/api/__tests__/finished-goods.integration.test.ts` | `deleteFinishedGood: vi.fn(),` | L30 |
| `src/app/api/__tests__/finished-goods.integration.test.ts` | `canDeleteFinishedGoods: vi.fn(),` | L39 |
| `src/app/api/__tests__/finished-goods.integration.test.ts` | `describe('DELETE /api/finished-goods/[id]', () => \{` | L222 |
| `src/app/api/__tests__/finished-goods.integration.test.ts` | `it('should delete finished good when authorized', async () => \{` | L223 |
| `src/app/api/__tests__/finished-goods.integration.test.ts` | `vi.mocked(canDeleteFinishedGoods).mockReturnValue(true)` | L232 |
| `src/app/api/__tests__/finished-goods.integration.test.ts` | `vi.mocked(deleteFinishedGood).mockResolvedValue(undefined)` | L233 |
| `src/app/api/__tests__/finished-goods.integration.test.ts` | `method: 'DELETE',` | L238 |
| `src/app/api/__tests__/finished-goods.integration.test.ts` | `const response = await DELETE(request, \{` | L242 |
| `src/app/api/__tests__/finished-goods.integration.test.ts` | `expect(deleteFinishedGood).toHaveBeenCalledWith('123')` | L249 |
| `src/app/api/__tests__/users-id.integration.test.ts` | `import \{ GET, PUT, DELETE \} from '../users/[id]/route'` | L7 |
| `src/app/api/__tests__/users-id.integration.test.ts` | `import \{ getUserById, updateUser, deleteUser \} from '@/lib/services'` | L8 |
| `src/app/api/__tests__/users-id.integration.test.ts` | `deleteUser: vi.fn(),` | L17 |
| `src/app/api/__tests__/users-id.integration.test.ts` | `userDeleted: vi.fn().mockResolvedValue(undefined),` | L39 |
| `src/app/api/__tests__/users-id.integration.test.ts` | `describe('DELETE /api/users/[id]', () => \{` | L122 |
| `src/app/api/__tests__/users-id.integration.test.ts` | `it('should delete user when authorized', async () => \{` | L123 |
| `src/app/api/__tests__/users-id.integration.test.ts` | `const mockUserToDelete = createTestUser(\{ id: '123' \})` | L130 |
| `src/app/api/__tests__/users-id.integration.test.ts` | `vi.mocked(getUserById).mockResolvedValue(mockUserToDelete)` | L135 |
| `src/app/api/__tests__/users-id.integration.test.ts` | `vi.mocked(deleteUser).mockResolvedValue(undefined)` | L136 |
| `src/app/api/__tests__/users-id.integration.test.ts` | `method: 'DELETE',` | L139 |
| `src/app/api/__tests__/users-id.integration.test.ts` | `const response = await DELETE(request, \{` | L142 |
| `src/app/api/__tests__/users-id.integration.test.ts` | `expect(deleteUser).toHaveBeenCalledWith('123', 'admin-1')` | L149 |
| `src/app/api/__tests__/users-id.integration.test.ts` | `expect(AuditHelpers.userDeleted).toHaveBeenCalled()` | L150 |
| `src/app/api/stock-movements/by-date/route.ts` | `canDeleteStockMovements,` | L6 |
| `src/app/api/stock-movements/by-date/route.ts` | `deleteStockMovementsByDate,` | L12 |
| `src/app/api/stock-movements/by-date/route.ts` | `stockMovementByDateDeleteSchema,` | L16 |
| `src/app/api/stock-movements/by-date/route.ts` | `export async function DELETE(request: NextRequest) \{` | L20 |
| `src/app/api/stock-movements/by-date/route.ts` | `if (!canDeleteStockMovements(session.user.role)) \{` | L28 |
| `src/app/api/stock-movements/by-date/route.ts` | `'delete stock movements',` | L32 |
| `src/app/api/stock-movements/by-date/route.ts` | `const validatedQuery = stockMovementByDateDeleteSchema.parse(query)` | L48 |
| `src/app/api/stock-movements/by-date/route.ts` | `// Delete stock movements using service` | L51 |
| `src/app/api/stock-movements/by-date/route.ts` | `await deleteStockMovementsByDate(` | L52 |
| `src/app/api/stock-movements/by-date/route.ts` | `message: 'Stock movements deleted successfully',` | L60 |
| `src/app/api/stock-movements/by-date/route.ts` | `\{ error: 'Failed to delete stock movements' \},` | L77 |
| `src/app/api/users/[id]/route.ts` | `deleteUser,` | L10 |
| `src/app/api/users/[id]/route.ts` | `export async function DELETE(` | L93 |
| `src/app/api/users/[id]/route.ts` | `\{ error: getPermissionErrorMessage('delete users', session.user.role) \},` | L106 |
| `src/app/api/users/[id]/route.ts` | `// Delete user using service (includes self-deletion and last-admin checks)` | L116 |
| `src/app/api/users/[id]/route.ts` | `await deleteUser(id, session.user.id)` | L117 |
| `src/app/api/users/[id]/route.ts` | `await AuditHelpers.userDeleted(` | L120 |
| `src/app/api/users/[id]/route.ts` | `return NextResponse.json(\{ message: 'User deleted successfully' \})` | L131 |
| `src/app/api/users/[id]/route.ts` | `\{ error: 'Failed to delete user' \},` | L140 |


</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "delete|DELETE" in "src/lib/services" • 143 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `src/lib/services/finished-good.service.ts` | `* Delete a finished good` | L197 |
| `src/lib/services/finished-good.service.ts` | `export async function deleteFinishedGood(id: string): Promise<void> \{` | L208 |
| `src/lib/services/finished-good.service.ts` | `throw new Error('Cannot delete finished good that has stock movements')` | L225 |
| `src/lib/services/finished-good.service.ts` | `await prisma.finishedGood.delete(\{` | L228 |
| `src/lib/services/stock-movement.service.ts` | `* Delete stock movements by date and update stock` | L355 |
| `src/lib/services/stock-movement.service.ts` | `* @param date - Date to delete movements for` | L359 |
| `src/lib/services/stock-movement.service.ts` | `* @param movementType - Type of movement to delete ('IN' or 'OUT')` | L360 |
| `src/lib/services/stock-movement.service.ts` | `export async function deleteStockMovementsByDate(` | L371 |
| `src/lib/services/stock-movement.service.ts` | `// Find movements to delete` | L382 |
| `src/lib/services/stock-movement.service.ts` | `throw new Error('No movements found to delete')` | L397 |
| `src/lib/services/stock-movement.service.ts` | `// Delete the movements` | L403 |
| `src/lib/services/stock-movement.service.ts` | `await tx.stockMovement.deleteMany(\{` | L404 |
| `src/lib/services/stock-movement.service.ts` | ``Cannot delete movements: would result in negative stock for $\{item.name\} ($\{newStock.toFixed(2)\})`` | L433 |
| `src/lib/services/stock-movement.service.ts` | ``Cannot delete movements: would result in negative stock for $\{item.name\} ($\{newStock.toFixed(2)\})`` | L464 |
| `src/lib/services/stock-movement.service.ts` | ``To preserve audit trail, please delete and recreate, or edit individual movements.`` | L541 |
| `src/lib/services/stock-movement.service.ts` | `// If new quantity is 0, just delete existing movements` | L548 |
| `src/lib/services/stock-movement.service.ts` | `await tx.stockMovement.deleteMany(\{` | L551 |
| `src/lib/services/stock-movement.service.ts` | `// Delete all existing movements for this day` | L556 |
| `src/lib/services/stock-movement.service.ts` | `await tx.stockMovement.deleteMany(\{` | L558 |
| `src/lib/services/stock-movement.service.ts` | `* Delete individual stock movement and reverse stock effects` | L900 |
| `src/lib/services/stock-movement.service.ts` | `* - Cannot delete movements that are part of batches (data integrity)` | L909 |
| `src/lib/services/stock-movement.service.ts` | `export async function deleteStockMovement(movementId: string): Promise<void> \{` | L913 |
| `src/lib/services/stock-movement.service.ts` | `'This movement is part of a batch. Delete the batch instead.'` | L938 |
| `src/lib/services/stock-movement.service.ts` | ``Cannot delete movement: would result in negative drum stock. Current: $\{drum[0].currentQuantity\}, Change: $\{reverseChange\}`` | L971 |
| `src/lib/services/stock-movement.service.ts` | ``Cannot delete movement: would result in negative stock for $\{item.name\} ($\{newStock.toFixed(2)\})`` | L1004 |
| `src/lib/services/stock-movement.service.ts` | `// Stock doesn't exist, but we'll still try to delete the movement` | L1031 |
| `src/lib/services/stock-movement.service.ts` | ``Cannot delete movement: would result in negative stock at location ($\{newQuantity.toFixed(2)\})`` | L1039 |
| `src/lib/services/stock-movement.service.ts` | ``Cannot delete movement: would result in negative stock for $\{item.name\} ($\{newStock.toFixed(2)\})`` | L1075 |
| `src/lib/services/stock-movement.service.ts` | `// Delete the movement` | L1087 |
| `src/lib/services/stock-movement.service.ts` | `await tx.stockMovement.delete(\{` | L1088 |
| `src/lib/services/raw-material.service.ts` | `* Delete a raw material` | L184 |
| `src/lib/services/raw-material.service.ts` | `* - Cascade deletes handled by Prisma schema` | L191 |
| `src/lib/services/raw-material.service.ts` | `export async function deleteRawMaterial(id: string): Promise<void> \{` | L194 |
| `src/lib/services/raw-material.service.ts` | `await prisma.rawMaterial.delete(\{` | L203 |
| `src/lib/services/batch.service.ts` | `* - Deletes old relations and creates new ones` | L442 |
| `src/lib/services/batch.service.ts` | `// Delete old stock movement` | L526 |
| `src/lib/services/batch.service.ts` | `await tx.stockMovement.deleteMany(\{` | L527 |
| `src/lib/services/batch.service.ts` | `// Step 2: Delete all old batch usages` | L535 |
| `src/lib/services/batch.service.ts` | `await tx.batchUsage.deleteMany(\{` | L536 |
| `src/lib/services/batch.service.ts` | `* Delete a batch and restore all stock` | L690 |
| `src/lib/services/batch.service.ts` | `* - Deletes all related records in correct order` | L698 |
| `src/lib/services/batch.service.ts` | `export async function deleteBatch(id: string): Promise<void> \{` | L701 |
| `src/lib/services/batch.service.ts` | `// Transaction: Delete batch and restore stock` | L714 |
| `src/lib/services/batch.service.ts` | `// Step 2: Delete stock movements associated with this batch FIRST` | L741 |
| `src/lib/services/batch.service.ts` | `await tx.stockMovement.deleteMany(\{` | L743 |
| `src/lib/services/batch.service.ts` | `// Step 3: Delete all batch usages` | L747 |
| `src/lib/services/batch.service.ts` | `await tx.batchUsage.deleteMany(\{` | L748 |
| `src/lib/services/batch.service.ts` | `// Step 4: Delete the batch` | L752 |
| `src/lib/services/batch.service.ts` | `await tx.batch.delete(\{` | L753 |
| `src/lib/services/__tests__/batch.service.test.ts` | `deleteBatch,` | L14 |
| `src/lib/services/__tests__/batch.service.test.ts` | `delete: vi.fn(),` | L33 |
| `src/lib/services/__tests__/batch.service.test.ts` | `deleteMany: vi.fn(),` | L38 |
| `src/lib/services/__tests__/batch.service.test.ts` | `deleteMany: vi.fn(),` | L42 |
| `src/lib/services/__tests__/batch.service.test.ts` | `delete: vi.fn(),` | L57 |
| `src/lib/services/__tests__/batch.service.test.ts` | `deleteMany: vi.fn(),` | L61 |
| `src/lib/services/__tests__/batch.service.test.ts` | `deleteMany: vi.fn(),` | L65 |
| `src/lib/services/__tests__/batch.service.test.ts` | `deleteMany: vi.fn().mockResolvedValue(\{ count: 1 \}),` | L505 |
| `src/lib/services/__tests__/batch.service.test.ts` | `deleteMany: vi.fn().mockResolvedValue(\{ count: 2 \}),` | L509 |
| `src/lib/services/__tests__/batch.service.test.ts` | `batchUsage: \{ create: vi.fn(), deleteMany: vi.fn() \},` | L652 |
| `src/lib/services/__tests__/batch.service.test.ts` | `stockMovement: \{ create: vi.fn(), deleteMany: vi.fn() \},` | L653 |
| `src/lib/services/__tests__/batch.service.test.ts` | `batchUsage: \{ create: vi.fn(), deleteMany: vi.fn() \},` | L690 |
| `src/lib/services/__tests__/batch.service.test.ts` | `stockMovement: \{ create: vi.fn(), deleteMany: vi.fn() \},` | L691 |
| `src/lib/services/__tests__/batch.service.test.ts` | `describe('deleteBatch', () => \{` | L718 |
| `src/lib/services/__tests__/batch.service.test.ts` | `it('should delete batch and restore all stock', async () => \{` | L719 |
| `src/lib/services/__tests__/batch.service.test.ts` | `delete: vi.fn().mockResolvedValue(existingBatch),` | L734 |
| `src/lib/services/__tests__/batch.service.test.ts` | `deleteMany: vi.fn().mockResolvedValue(\{ count: 1 \}),` | L737 |
| `src/lib/services/__tests__/batch.service.test.ts` | `deleteMany: vi.fn().mockResolvedValue(\{ count: 2 \}),` | L740 |
| `src/lib/services/__tests__/batch.service.test.ts` | `await deleteBatch(batchId)` | L765 |
| `src/lib/services/__tests__/batch.service.test.ts` | `expect(mockTx.stockMovement.deleteMany).toHaveBeenCalledWith(\{` | L774 |
| `src/lib/services/__tests__/batch.service.test.ts` | `expect(mockTx.batch.delete).toHaveBeenCalledWith(\{` | L777 |
| `src/lib/services/__tests__/batch.service.test.ts` | `await expect(deleteBatch('non-existent')).rejects.toThrow(` | L785 |
| `src/lib/services/index.ts` | `deleteStockMovementsByDate,` | L22 |
| `src/lib/services/index.ts` | `deleteStockMovement,` | L25 |
| `src/lib/services/location.service.ts` | `* Delete a location` | L103 |
| `src/lib/services/location.service.ts` | `export async function deleteLocation(id: string) \{` | L107 |
| `src/lib/services/location.service.ts` | `throw new Error('Cannot delete location with active stock.')` | L114 |
| `src/lib/services/location.service.ts` | `// Soft delete or block?` | L122 |
| `src/lib/services/location.service.ts` | `// Requirements say "Audit Trail", so maybe we shouldn't delete locations with history.` | L123 |
| `src/lib/services/location.service.ts` | `throw new Error('Cannot delete location with associated movement history.')` | L125 |
| `src/lib/services/location.service.ts` | `return await prisma.location.delete(\{` | L128 |
| `src/lib/services/__tests__/user.service.test.ts` | `deleteUser,` | L11 |
| `src/lib/services/__tests__/user.service.test.ts` | `delete: vi.fn(),` | L25 |
| `src/lib/services/__tests__/user.service.test.ts` | `describe('deleteUser', () => \{` | L265 |
| `src/lib/services/__tests__/user.service.test.ts` | `it('should delete user', async () => \{` | L266 |
| `src/lib/services/__tests__/user.service.test.ts` | `vi.mocked(prisma.user.delete).mockResolvedValue(mockUser)` | L272 |
| `src/lib/services/__tests__/user.service.test.ts` | `await deleteUser('test-id', 'other-user-id')` | L274 |
| `src/lib/services/__tests__/user.service.test.ts` | `expect(prisma.user.delete).toHaveBeenCalledWith(\{` | L276 |
| `src/lib/services/__tests__/user.service.test.ts` | `await expect(deleteUser('non-existent', 'current-user')).rejects.toThrow(` | L284 |
| `src/lib/services/__tests__/user.service.test.ts` | `it('should throw error when trying to delete self', async () => \{` | L289 |
| `src/lib/services/__tests__/user.service.test.ts` | `await expect(deleteUser('test-id', 'test-id')).rejects.toThrow(` | L293 |
| `src/lib/services/__tests__/user.service.test.ts` | `'Cannot delete your own account'` | L294 |
| `src/lib/services/__tests__/user.service.test.ts` | `await expect(deleteUser('test-id', 'other-user')).rejects.toThrow(` | L303 |
| `src/lib/services/__tests__/user.service.test.ts` | `'Cannot delete the last admin user'` | L304 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `deleteStockMovementsByDate,` | L11 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `deleteMany: vi.fn(),` | L27 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `deleteMany: vi.fn(),` | L43 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `describe('deleteStockMovementsByDate', () => \{` | L500 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `it('should delete movements and restore stock for raw material', async () => \{` | L501 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `deleteMany: vi.fn().mockResolvedValue(\{ count: 1 \}),` | L523 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `await deleteStockMovementsByDate(itemId, itemType, date, 'IN')` | L552 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `expect(mockTx.stockMovement.deleteMany).toHaveBeenCalled()` | L554 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `it('should delete movements and restore stock for finished good', async () => \{` | L561 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `deleteMany: vi.fn().mockResolvedValue(\{ count: 1 \}),` | L583 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `await deleteStockMovementsByDate(itemId, itemType, date, 'IN')` | L612 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `deleteMany: vi.fn(),` | L655 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `it('should delete movements when quantity is 0', async () => \{` | L687 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `deleteMany: vi.fn().mockResolvedValue(\{ count: 1 \}),` | L710 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `expect(mockTx.stockMovement.deleteMany).toHaveBeenCalled()` | L750 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `deleteMany: vi.fn().mockResolvedValue(\{ count: 1 \}),` | L781 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `expect(mockTx.stockMovement.deleteMany).toHaveBeenCalled()` | L824 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `deleteMany: vi.fn().mockResolvedValue(\{ count: 1 \}),` | L851 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `deleteMany: vi.fn().mockResolvedValue(\{ count: 1 \}),` | L909 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `deleteMany: vi.fn().mockResolvedValue(\{ count: 1 \}),` | L971 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `deleteMany: vi.fn().mockResolvedValue(\{ count: 1 \}),` | L1044 |
| `src/lib/services/__tests__/stock-movement.service.test.ts` | `deleteMany: vi.fn().mockResolvedValue(\{ count: 1 \}),` | L1103 |
| `src/lib/services/__tests__/finished-good.service.test.ts` | `deleteFinishedGood,` | L11 |
| `src/lib/services/__tests__/finished-good.service.test.ts` | `delete: vi.fn(),` | L24 |
| `src/lib/services/__tests__/finished-good.service.test.ts` | `describe('deleteFinishedGood', () => \{` | L147 |
| `src/lib/services/__tests__/finished-good.service.test.ts` | `it('should delete finished good when no movements', async () => \{` | L148 |
| `src/lib/services/__tests__/finished-good.service.test.ts` | `vi.mocked(prisma.finishedGood.delete).mockResolvedValue(mockGood)` | L158 |
| `src/lib/services/__tests__/finished-good.service.test.ts` | `await deleteFinishedGood('test-id')` | L160 |
| `src/lib/services/__tests__/finished-good.service.test.ts` | `expect(prisma.finishedGood.delete).toHaveBeenCalledWith(\{` | L162 |
| `src/lib/services/__tests__/finished-good.service.test.ts` | `await expect(deleteFinishedGood('non-existent')).rejects.toThrow(` | L170 |
| `src/lib/services/__tests__/finished-good.service.test.ts` | `await expect(deleteFinishedGood('test-id')).rejects.toThrow(` | L186 |
| `src/lib/services/__tests__/finished-good.service.test.ts` | `'Cannot delete finished good that has stock movements'` | L187 |
| `src/lib/services/user.service.ts` | `* Delete a user` | L235 |
| `src/lib/services/user.service.ts` | `* @throws \{Error\} If attempting to delete own account` | L241 |
| `src/lib/services/user.service.ts` | `* - Hard delete (not soft delete)` | L245 |
| `src/lib/services/user.service.ts` | `* - Cascade deletes handled by Prisma schema (accounts, sessions)` | L248 |
| `src/lib/services/user.service.ts` | `export async function deleteUser(` | L250 |
| `src/lib/services/user.service.ts` | `throw new Error('Cannot delete your own account')` | L264 |
| `src/lib/services/user.service.ts` | `throw new Error('Cannot delete the last admin user')` | L274 |
| `src/lib/services/user.service.ts` | `// Delete user` | L278 |
| `src/lib/services/user.service.ts` | `await prisma.user.delete(\{` | L279 |
| `src/lib/services/__tests__/raw-material.service.test.ts` | `deleteRawMaterial,` | L13 |
| `src/lib/services/__tests__/raw-material.service.test.ts` | `delete: vi.fn(),` | L31 |
| `src/lib/services/__tests__/raw-material.service.test.ts` | `describe('deleteRawMaterial', () => \{` | L255 |
| `src/lib/services/__tests__/raw-material.service.test.ts` | `it('should delete raw material', async () => \{` | L256 |
| `src/lib/services/__tests__/raw-material.service.test.ts` | `vi.mocked(prisma.rawMaterial.delete).mockResolvedValue(mockMaterial)` | L259 |
| `src/lib/services/__tests__/raw-material.service.test.ts` | `await deleteRawMaterial('test-id')` | L261 |
| `src/lib/services/__tests__/raw-material.service.test.ts` | `expect(prisma.rawMaterial.delete).toHaveBeenCalledWith(\{` | L266 |
| `src/lib/services/__tests__/raw-material.service.test.ts` | `await expect(deleteRawMaterial('non-existent')).rejects.toThrow(` | L274 |
| `src/lib/services/__tests__/raw-material.service.test.ts` | `expect(prisma.rawMaterial.delete).not.toHaveBeenCalled()` | L277 |


</details>
</tool-use>

---



---

Reviewing delete service implementations and API routes:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/lib/services/raw-material.service.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/lib/services/finished-good.service.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/lib/services/batch.service.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/lib/services/stock-movement.service.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/lib/services/user.service.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/lib/services/location.service.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/app/api/raw-materials/[id]/route.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/app/api/finished-goods/[id]/route.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/app/api/batches/[id]/route.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/app/api/users/[id]/route.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/app/api/stock-movements/[id]/route.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/app/api/locations/[id]/route.ts</summary>

</details>
</tool-use>

---



---

Checking the delete-by-date function and reviewing tests for issues:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/lib/services/stock-movement.service.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/app/api/stock-movements/by-date/route.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "delete function error handling issues bugs" • **12** results</summary>
            
| File | Lines |
|------|-------|
| `src/app/api/batches/[id]/route.ts` | L247-320 |
| `src/app/api/users/[id]/route.ts` | L178-257 |
| `src/app/api/finished-goods/[id]/route.ts` | L65-106 |
| `src/app/finished-goods/page.tsx` | L14-298 |
| `src/app/api/raw-materials/[id]/route.ts` | L59-153 |
| `src/app/batches/page.tsx` | L18-179 |
| `src/app/api/stock-movements/by-date/route.ts` | L19-138 |
| `src/app/raw-materials/page.tsx` | L23-246 |
| `src/app/api/stock-movements/by-date/route.ts` | L19-80 |
| `src/app/api/stock-movements/by-date/route.ts` | L80 |
| `src/components/users/users-table.tsx` | L28-191 |
| `src/lib/api-client.ts` | L82-94 |

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "deleteRawMaterial|deleteFinishedGood|deleteBatch|deleteStockMovement|deleteUser|deleteLocation" in "src/components" • 0 matches</summary>

Output mode: content


_No matches found_

</details>
</tool-use>

---



---

Checking a potential issue in `deleteStockMovementsByDate` and verifying the location delete route:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/lib/services/stock-movement.service.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "canDelete|canManage" in "src/app/api/locations" • 0 matches</summary>

Output mode: content


_No matches found_

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/lib/rbac.ts</summary>

</details>
</tool-use>

---



---

Checking if `deleteStockMovementsByDate` handles location-specific stock for finished goods:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/lib/services/stock-movement.service.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "finished good stock location specific update delete" • **8** results</summary>
            
| File | Lines |
|------|-------|
| `src/app/api/stock-movements/by-date/route.ts` | L19-138 |
| `src/app/api/finished-goods/[id]/route.ts` | L65-106 |
| `src/app/api/stock-movements/route.ts` | L63-230 |
| `src/app/api/batches/[id]/route.ts` | L247-320 |
| `prisma/schema.prisma` | L44-94 |
| `src/app/api/finished-goods/[id]/route.ts` | L106 |
| `src/app/api/batches/[id]/route.ts` | L49-155 |
| `src/components/finished-goods/finished-goods-table.tsx` | L26-249 |

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "finishedGoodStock|locationId" in "src/lib/services/stock-movement.service.ts" • 34 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `src/lib/services/stock-movement.service.ts` | `locationId?: string \| null` | L30 |
| `src/lib/services/stock-movement.service.ts` | `* @param locationId - Optional location ID for finished goods` | L74 |
| `src/lib/services/stock-movement.service.ts` | `* - For finished goods: filters by locationId if provided` | L80 |
| `src/lib/services/stock-movement.service.ts` | `locationId?: string \| null,` | L88 |
| `src/lib/services/stock-movement.service.ts` | `...(locationId ? \{ locationId \} : \{}),` | L107 |
| `src/lib/services/stock-movement.service.ts` | `itemType === 'finished-good' ? data.locationId : null,` | L148 |
| `src/lib/services/stock-movement.service.ts` | `if (!data.locationId) \{` | L234 |
| `src/lib/services/stock-movement.service.ts` | `const finishedGoodStocks = await tx.finishedGoodStock.findUnique(\{` | L242 |
| `src/lib/services/stock-movement.service.ts` | `finishedGoodId_locationId: \{` | L244 |
| `src/lib/services/stock-movement.service.ts` | `locationId: data.locationId,` | L246 |
| `src/lib/services/stock-movement.service.ts` | `const currentStock = finishedGoodStocks?.quantity \|\| 0` | L257 |
| `src/lib/services/stock-movement.service.ts` | `if (!data.locationId) throw new Error('Location required')` | L316 |
| `src/lib/services/stock-movement.service.ts` | `await tx.finishedGoodStock.upsert(\{` | L319 |
| `src/lib/services/stock-movement.service.ts` | `finishedGoodId_locationId: \{` | L321 |
| `src/lib/services/stock-movement.service.ts` | `locationId: data.locationId,` | L323 |
| `src/lib/services/stock-movement.service.ts` | `locationId: data.locationId,` | L331 |
| `src/lib/services/stock-movement.service.ts` | `* @param data - Update data (quantity, date, description, locationId)` | L653 |
| `src/lib/services/stock-movement.service.ts` | `locationId?: string \| null` | L672 |
| `src/lib/services/stock-movement.service.ts` | `const oldLocationId = existingMovement.locationId` | L712 |
| `src/lib/services/stock-movement.service.ts` | `const newLocationId = data.locationId ?? oldLocationId` | L715 |
| `src/lib/services/stock-movement.service.ts` | `locationId:` | L774 |
| `src/lib/services/stock-movement.service.ts` | `: existingMovement.locationId,` | L777 |
| `src/lib/services/stock-movement.service.ts` | `await tx.finishedGoodStock` | L807 |
| `src/lib/services/stock-movement.service.ts` | `finishedGoodId_locationId: \{` | L810 |
| `src/lib/services/stock-movement.service.ts` | `locationId: oldLocationId,` | L812 |
| `src/lib/services/stock-movement.service.ts` | `await tx.finishedGoodStock.upsert(\{` | L869 |
| `src/lib/services/stock-movement.service.ts` | `finishedGoodId_locationId: \{` | L871 |
| `src/lib/services/stock-movement.service.ts` | `locationId: newLocationId,` | L873 |
| `src/lib/services/stock-movement.service.ts` | `locationId: newLocationId,` | L881 |
| `src/lib/services/stock-movement.service.ts` | `if (!existingMovement.locationId) \{` | L1018 |
| `src/lib/services/stock-movement.service.ts` | `AND "locationId" = $\{existingMovement.locationId\}` | L1026 |
| `src/lib/services/stock-movement.service.ts` | `await tx.finishedGoodStock.update(\{` | L1043 |
| `src/lib/services/stock-movement.service.ts` | `finishedGoodId_locationId: \{` | L1045 |
| `src/lib/services/stock-movement.service.ts` | `locationId: existingMovement.locationId,` | L1047 |


</details>
</tool-use>

---



---

Creating a plan to fix the identified issues:


---

<tool-use data-tool-type="unknown" data-tool-name="create_plan">
<details>
<summary>Tool use: **create_plan**</summary>


Parameters:

```json
{
  "plan": "# Fix Delete Functions\n\n## Issues Found\n\n1. **Location DELETE route** (&#96;src/app/api/locations/[id]/route.ts&#96;):\n   - Missing authentication check\n   - Missing authorization check (should verify ADMIN role)\n   - Missing proper error handling with status codes\n   - Missing logger usage\n\n2. **deleteStockMovementsByDate** (&#96;src/lib/services/stock-movement.service.ts&#96;):\n   - **Critical Bug**: For finished goods, only updates global stock but doesn't update location-specific &#96;finishedGoodStock&#96; table\n   - Should handle location-specific stock updates similar to &#96;deleteStockMovement&#96;\n\n3. **deleteRawMaterial** (&#96;src/lib/services/raw-material.service.ts&#96;):\n   - Missing check for stock movements (similar to &#96;deleteFinishedGood&#96;)\n   - Comment indicates this should be enforced but currently isn't\n\n4. **deleteStockMovementsByDate** order of operations:\n   - Currently deletes movements first, then updates stock\n   - While in a transaction (so safe), should validate stock first before deletion for better error messages\n\n## Implementation Plan\n\n### 1. Fix Location DELETE Route\n**File**: &#96;src/app/api/locations/[id]/route.ts&#96;\n\n- Add authentication check using &#96;auth()&#96;\n- Add authorization check using &#96;canManageUsers&#96; (locations are admin-only)\n- Add proper error handling with appropriate HTTP status codes\n- Add logger for error tracking\n- Follow the same pattern as other delete routes\n\n### 2. Fix deleteStockMovementsByDate for Finished Goods\n**File**: &#96;src/lib/services/stock-movement.service.ts&#96;\n\n- When deleting finished good movements, update location-specific stock in &#96;finishedGoodStock&#96; table\n- Group movements by &#96;locationId&#96; and update each location's stock separately\n- Handle cases where movements span multiple locations\n- Follow the same pattern as &#96;deleteStockMovement&#96; (lines 1016-1054)\n\n### 3. Add Stock Movement Check to deleteRawMaterial\n**File**: &#96;src/lib/services/raw-material.service.ts&#96;\n\n- Add check for existing stock movements before deletion\n- Prevent deletion if raw material has transaction history\n- Follow the same pattern as &#96;deleteFinishedGood&#96; (lines 208-231)\n\n### 4. Improve deleteStockMovementsByDate Order\n**File**: &#96;src/lib/services/stock-movement.service.ts&#96;\n\n- Validate stock levels before deleting movements\n- This provides better error messages and follows defensive programming practices\n- Transaction ensures atomicity regardless of order\n\n## Testing Strategy\n\n1. Test location deletion with/without authentication\n2. Test location deletion with different user roles\n3. Test deleteStockMovementsByDate with finished goods at multiple locations\n4. Test raw material deletion with/without stock movements\n5. Verify all delete operations maintain data integrity\n\n## Files to Modify\n\n- &#96;src/app/api/locations/[id]/route.ts&#96; - Add auth/authorization/error handling\n- &#96;src/lib/services/stock-movement.service.ts&#96; - Fix finished good location stock handling\n- &#96;src/lib/services/raw-material.service.ts&#96; - Add stock movement validation",
  "name": "Fix Delete Functions",
  "todos": [
    {
      "content": "Add authentication, authorization, proper error handling, and logger to location DELETE route",
      "status": "pending",
      "id": "fix-location-delete-route"
    },
    {
      "content": "Fix deleteStockMovementsByDate to update location-specific finishedGoodStock table for finished goods",
      "status": "pending",
      "id": "fix-delete-stock-movements-by-date-finished-goods"
    },
    {
      "content": "Add stock movement validation to deleteRawMaterial to prevent deletion with transaction history",
      "status": "pending",
      "id": "add-stock-movement-check-raw-material"
    },
    {
      "content": "Improve deleteStockMovementsByDate to validate stock before deleting movements",
      "status": "pending",
      "id": "improve-delete-order-validation",
      "dependencies": [
        "fix-delete-stock-movements-by-date-finished-goods"
      ]
    }
  ],
  "overview": "Fix critical issues in delete functions: add missing authentication/authorization for location deletion, fix location-specific stock handling in deleteStockMovementsByDate, add stock movement checks to raw material deletion, and improve error handling consistency."
}
```
Additional data:

```json
{
  "reviewData": {
    "status": "Requested",
    "selectedOption": "none",
    "isShowingInput": false
  },
  "planUri": "file:///home/antonius/.cursor/plans/fix_delete_functions_7fe13e79.plan.md",
  "hasOpenedEditor": true,
  "pinnedName": "Fix Delete Functions"
}
```
Result:

```json
{
  "accepted": {
    "finalTodos": [
      {
        "content": "Add authentication, authorization, proper error handling, and logger to location DELETE route",
        "status": "pending",
        "id": "fix-location-delete-route"
      },
      {
        "content": "Fix deleteStockMovementsByDate to update location-specific finishedGoodStock table for finished goods",
        "status": "pending",
        "id": "fix-delete-stock-movements-by-date-finished-goods"
      },
      {
        "content": "Add stock movement validation to deleteRawMaterial to prevent deletion with transaction history",
        "status": "pending",
        "id": "add-stock-movement-check-raw-material"
      },
      {
        "content": "Improve deleteStockMovementsByDate to validate stock before deleting movements",
        "status": "pending",
        "id": "improve-delete-order-validation"
      }
    ]
  },
  "planUri": "/home/antonius/.cursor/plans/fix_delete_functions_7fe13e79.plan.md"
}
```
Status: **completed**


</details>
</tool-use>

---

